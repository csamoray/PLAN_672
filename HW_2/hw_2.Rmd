---
title: "hw2"
author: "Chris Samoray"
date: "9/3/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(lubridate)
library(leaflet)
```

```{r}
# load NO2 & O3 data from 2021
no2.df <- read_csv("../HW_2/data/daily_42602_2021.csv")
o3.df <- read_csv("../HW_2/data/daily_44201_2021.csv")

##############
# clean data
##############

# what does data look like?
glimpse(no2.df) 
glimpse(o3.df) 

# function to clean datasets
aqi.fcn <- function(x){
  
# remove spaces in column names
names(x) <- gsub(" ", "_", names(x)) 

# create new column of state/co fips code
x$stcofips <- paste(formatC(x$State_Code, width = 2, flag = "0"), formatC(x$County_Code, width = 3, flag = "0"), sep = "") # flag searches for leading zeros

print(x$stcofips %>% unique() %>% length()) # how many counties included
print(unique(nchar(x$stcofips))) # all have fips with 5 numbers

# select columns of interest
x <- x %>% select(stcofips, State_Name, County_Name, CBSA_Name, Site_Num, Longitude, Latitude, Date_Local, AQI, Parameter_Name)

x <- x %>%  mutate(month = substr(Date_Local, 6, 7),
                                 sitetag = 1) # to denote 1 monitor 
 return(x)
}

no2.df2 <- aqi.fcn(no2.df) # clean no2
o3.df2 <- aqi.fcn(o3.df) # clean o3

```


```{r}
##############
# create summary dfs
##############

# # select max recording of all cbsa monitors for each day
# # this is imperfect bc some monitors record the same aqi number on some days
#          
# no2.group <- no2.df2 %>% group_by(stcofips, Date_Local) %>%        arrange(desc(AQI), .by_group = T) %>% 
#                           summarize(maxAQI = max(AQI),
#                           Site_Num = first(Site_Num),
#                           State_Name = first(State_Name),
#                           County_Name = first(County_Name),
#                           CBSA_Name = first(CBSA_Name),
#                           Longitude = first(Longitude),
#                           Latitude = first(Latitude))
                         
# no2.group <- no2.df2 %>% group_by(stcofips, Date_Local) %>%        arrange(desc(AQI), .by_group = T) %>% 
#                           summarize(maxAQI = max(AQI),
#                           Site_Num = first(Site_Num),
#                           State_Name = first(State_Name),
#                           County_Name = first(County_Name),
#                           CBSA_Name = first(CBSA_Name),
#                           Longitude = first(Longitude),
#                           Latitude = first(Latitude))
#                   
# test <- no2.df2 %>% group_by(stcofips, month, Site_Num) %>% 
#                           summarise(aqi_month_avg = 
#                               sum(AQI) / sum(sitetag),
#                               State_Name = first(State_Name),
#                               County_Name = first(County_Name),
#                               CBSA_Name = first(CBSA_Name),
#                               Longitude = first(Longitude),
#                               Latitude = first(Latitude))

# select aqi monitor with highest monthly average based on daily max aqi in each cbsa 
aqi.month.avg.high <- function(x){
x <- x %>% group_by(stcofips, month, Site_Num) %>% 
                          summarise(aqi_month_avg = 
                              sum(AQI) / sum(sitetag),
                              State_Name = first(State_Name),
                              County_Name = first(County_Name),
                              CBSA_Name = first(CBSA_Name),
                              Longitude = first(Longitude),
                              Latitude = first(Latitude)) %>%
                          arrange(desc(aqi_month_avg), .by_group = T) %>% # select high
                          summarise(aqi_month_avg = first(aqi_month_avg),
                                    Site_Num = first(Site_Num), # why need this, shouldn't it be in the group?
                              State_Name = first(State_Name),
                              County_Name = first(County_Name),
                              CBSA_Name = first(CBSA_Name),
                              Longitude = first(Longitude),
                              Latitude = first(Latitude),.groups = "keep")
return(x)
}

no2.high <- aqi.month.avg.high(no2.df2)
o3.high <- aqi.month.avg.high(o3.df2)

# select aqi monitor with lowest monthly average based on daily max aqi in each cbsa 
aqi.month.avg.low <- function(x){
x <- x %>% group_by(stcofips, month, Site_Num) %>% 
                          summarise(aqi_month_avg = 
                              sum(AQI) / sum(sitetag),
                              State_Name = first(State_Name),
                              County_Name = first(County_Name),
                              CBSA_Name = first(CBSA_Name),
                              Longitude = first(Longitude),
                              Latitude = first(Latitude)) %>%
                          arrange(aqi_month_avg, .by_group = T) %>% # select low
                          summarise(aqi_month_avg = first(aqi_month_avg),
                          Site_Num = first(Site_Num), # why need this, shouldn't it be in the group?
                              State_Name = first(State_Name),
                              County_Name = first(County_Name),
                              CBSA_Name = first(CBSA_Name),
                              Longitude = first(Longitude),
                              Latitude = first(Latitude))
return(x)
}

no2.low <- aqi.month.avg.low(no2.df2)
o3.low <- aqi.month.avg.low(o3.df2)
```

```{r no2 max map}
no2.group$Date_Local <- mdy(no2.group$Date_Local)

```







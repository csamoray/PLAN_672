---
title: "lab3"
author: "Chris Samoray"
date: "2022-09-07"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(sf)
library(lubridate)
library(plotly)
library(leaflet)
library(widgetframe)
```

```{r}
nyc.data <- read_csv(here("lab3", "data", "201806-citibike-tripdata.csv"))
names(nyc.data)

```

```{r}
nyc.data <- rename(nyc.data, #rename column names to get rid of the space
                   Slat = `start station latitude`,
                   Slon = `start station longitude`,
                   Elat = `end station latitude`,
                   Elon = `end station longitude`,
                   Sstid = `start station id`,
                   Estid = `end station id`,
                   Estname = `end station name`,
                   Sstname = `start station name`)

nyc.data


#Convert gender and usertype to factor
nyc.data$gender <- factor(nyc.data$gender, labels=c('Unknown', 'Male', 'Female')) 
nyc.data$usertype <- factor(nyc.data$usertype)
summary(nyc.data)

quantile(nyc.data$tripduration, .9)

prop.table(table(nyc.data$usertype))

prop.table(table(nyc.data$gender))

prop.table(xtabs(~usertype+gender, data=nyc.data), margin=2)
```

```{r}
start_loc <- unique(nyc.data[,c('Slon', 'Slat', "Sstid", 'Sstname')]) %>% rename(Longitude = Slon, Latitude = Slat, Stid = Sstid, Stname=Sstname)
end_loc <- unique(nyc.data[,c('Elon', 'Elat', 'Estid', 'Estname')]) %>% rename(Longitude = Elon, Latitude = Elat, Stid = Estid, Stname=Estname)
station_loc <- unique(rbind(start_loc, end_loc))
rm(start_loc, end_loc)


m1 <- 
leaflet(station_loc) %>%
  addProviderTiles(providers$Stamen.TonerLines, group = "Basemap") %>%
  addProviderTiles(providers$Stamen.TonerLite, group = "Basemap") %>%
  addMarkers(label = paste(station_loc$Stid, station_loc$Longitude, station_loc$Latitude, station_loc$Stname, sep=",")
  )

widgetframe::frameWidget(m1)
```

```{r}
(eightDstations <- station_loc[grep(glob2rx("8D*"), station_loc$Stname),]$Stid) # these are the outliers stations in MTL
nyc.data[which.max(nyc.data$tripduration), c('Sstname', 'Estname','tripduration')]
(Bikedepots <- station_loc[grep(glob2rx("*CBS*"), station_loc$Stname),]$Stid) # parenthesis at the start is to print
```
```{r}
nyc.data %>%
  select(Sstid, Estid, tripduration) %>%
  filter(tripduration >= 60*60*2) %>%
  group_by(Sstid, Estid) %>%
  summarise(triptots = n(),
            averagetripdur = mean(tripduration)
            ) %>%
  arrange(desc(triptots))

station_loc <- station_loc[!(station_loc$Stid %in% Bikedepots |  station_loc$Stid %in% eightDstations), ]
nyc.data <-  nyc.data[nyc.data$Estid %in% station_loc$Stid & nyc.data$Sstid %in% station_loc$Stid, ]
diffdesttrips <- nyc.data[nyc.data$Estid != nyc.data$Sstid, ]
c(nrow(nyc.data), nrow(diffdesttrips))
nrow(station_loc)

summary(diffdesttrips)

```

```{r, EXERCISE 1}

# explore for patterns in high values using date
test <- diffdesttrips %>% filter(tripduration > 10000)

# many outliers have trips lasting over a month; let's select trips completed within 24 hours
diffdesttrips$timediff <- diffdesttrips$stoptime - diffdesttrips$starttime
diffdesttrips <- diffdesttrips %>% filter(timediff <= 1440) # data is in mins, 1440 mins = 24 hrs

rm(test)
rm(nyc.data)

summary(diffdesttrips)
prop.table(table(diffdesttrips$usertype))
prop.table(table(diffdesttrips$gender))
summary(diffdesttrips$`birth year`)

# let's also remove birth years 100 or more years or less than 5 years old
diffdesttrips <- diffdesttrips %>% filter(`birth year`> 1920 & `birth year`< 2013)
```

```{r}
numtrips_start_station <- diffdesttrips %>%
  mutate(day_of_week = wday(starttime, label=TRUE, week_start=1)) %>% #create weekday variable from start time
  group_by(Sstid, day_of_week, usertype) %>%
  summarise(Slon = first(Slon),
            Slat = first(Slat),
            totaltrips = n()
            )

numtrips_start_station %>%
  arrange(desc(totaltrips))

g1 <- ggplot(numtrips_start_station) +
  geom_point(aes(x=Slon, y=Slat, size=totaltrips), alpha=.5) +  # We use the  size of the point to denote its attraction
   scale_size_continuous(range= c(.1,2))+
  facet_grid(usertype ~ day_of_week) +  # Compare subscribers and customers
   scale_x_continuous("", breaks=NULL)+
   scale_y_continuous("", breaks=NULL)+
   theme(panel.background = element_rect(fill='white',colour='white'), legend.position = "none")  + coord_fixed()

ggplotly(g1)

# ggplot(diffdesttrips, aes(Slon, Slat)) +  
#     stat_density2d(aes(alpha=..level.., fill=..level..), size=2, 
#         bins=10, geom="polygon") + 
#     scale_fill_gradient(low = "blue", high = "red") +
#     scale_alpha(range = c(0.00, 0.5), guide = FALSE) +
#     geom_density2d(colour="black", bins=10) 
```

```{r, EXERCISE 2}

# the visualization shows the distribution throughout the week of trips taken by subscribers and customers in NYC. Most trips are taken in Manhattan. However, subscribers take more trips in the outer boroughs than customers. There does not seem to be much difference of time the time of week when subscribers take trips. For customers, the weekend looks like it might be slightly more popular than other days of the week. 

diffdesttrips <- diffdesttrips %>% mutate(hr = hour(starttime))


test <- diffdesttrips[diffdesttrips$Time2 > 17:00:00 & diffdesttrips$Time2 < 02:00:00, ]

trip.night <- diffdesttrips %>% filter(hms(Time2) > 17:00:00 & hms(Time2) < 02:00:00)
trip.day

```

